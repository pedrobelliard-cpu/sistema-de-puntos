
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Puntos 2026</title>
    <style>
        /* --- ESTILOS VISUALES (INTACTOS) --- */
        :root {
            --primary: #2563eb;
            --secondary: #1e293b;     
            --accent: #10b981;        
            --bg: #f1f5f9;            
            --card: #ffffff;          
            --danger: #ef4444;
            --edit: #f59e0b;
            --inactive: #64748b; /* Nuevo color para inactivos */
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--secondary);
            margin: 0; padding: 20px; display: flex; flex-direction: column; min-height: 100vh;
        }
        .container { max-width: 1280px; margin: 0 auto; width: 100%; flex: 1;
        }

        /* HEADER */
        .header { display: flex;
            justify-content: space-between; align-items: center; background: var(--card); padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 30px;
            border-left: 5px solid var(--primary); }
        .header h1 { margin: 0; font-size: 22px;
            color: var(--secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .header p { margin: 5px 0 0;
            color: var(--primary); font-size: 15px; font-weight: 700; }
        
        .actions { display: flex;
            gap: 10px; }

        .btn-main { background: var(--primary); color: white; border: none;
            padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .btn-main:hover { background: #1d4ed8; transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }

        .btn-print { background: var(--secondary);
            color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .btn-print:hover { background: #334155;
        }

        .btn-config { background: #cbd5e1; color: #334155; border: none; padding: 12px; border-radius: 8px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .btn-config:hover { background: #94a3b8; color: white;
        }

        /* KPI CARDS */
        .kpi-grid { display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card);
            padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .kpi-title { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; font-weight: 700;
        }
        .kpi-number { font-size: 36px; font-weight: 800; margin-top: 10px; color: var(--secondary);
        }
        
        /* GR√ÅFICAS */
        .charts-section { display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .chart-box { background: var(--card);
            padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .chart-header { font-weight: bold;
            margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;
        }
        
        .bar-container { display: flex;
            align-items: center; margin-bottom: 15px; font-size: 14px; }
        .bar-name { width: 140px; text-align: right;
            padding-right: 15px; font-weight: 500; color: #475569; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .bar-bg { flex: 1; background: #f1f5f9; height: 28px; border-radius: 6px; overflow: hidden;
            position: relative; }
        .bar-fill { height: 100%; display: flex; align-items: center; justify-content: flex-end;
            padding-right: 10px; color: white; font-weight: bold; font-size: 12px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* TABLA Y BUSCADOR */
        .table-box { background: var(--card);
            border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow-x: auto;
        }
        
        .table-header-row { display: flex;
            justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 1px solid #e2e8f0;
        }
        .table-title { font-weight: bold; font-size: 18px;
        }
        
        .search-container input { padding: 8px 12px;
            border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; width: 250px; outline: none; transition: 0.2s;
        }
        .search-container input:focus { border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        table { width: 100%;
            border-collapse: collapse; text-align: left; min-width: 800px; }
        th { background: #f8fafc;
            padding: 18px 25px;
            font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; border-bottom: 1px solid #e2e8f0; white-space: nowrap;
        }
        td { padding: 18px 25px; border-bottom: 1px solid #f1f5f9; color: #334155;
        }
        tr:last-child td { border-bottom: none;
        }
        tr:hover { background-color: #f8fafc;
        }
        
        /* ESTILOS PARA FILA INACTIVA */
        .tr-inactive {
            background-color: #f1f5f9 !important;
            opacity: 0.6;
            filter: grayscale(100%);
        }

        .badge { background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 20px;
            font-size: 11px; font-weight: bold; display: inline-block; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle;
        }
        .id-cell { font-family: monospace; font-weight: bold; color: #64748b; background: #f1f5f9;
            padding: 4px 8px; border-radius: 4px; font-size: 13px; border: 1px solid #e2e8f0;
        }
        
        /* BOTONES ACCI√ìN */
        .btn-group-action { display: flex;
            gap: 8px; justify-content: center; }
        .btn-icon { border: 1px solid #e2e8f0; background: white;
            padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; font-size: 14px;
        }
        
        .btn-edit { color: var(--primary);
            border-color: #bfdbfe; }
        .btn-edit:hover { background: var(--primary); color: white;
        }

        .btn-delete { color: var(--danger); border-color: #fecaca;
        }
        .btn-delete:hover { background: var(--danger); color: white;
        }

        /* Bot√≥n toggle inactivar */
        .btn-toggle { color: var(--edit); border-color: #fde68a; }
        .btn-toggle:hover { background: var(--edit); color: white; }

        /* FOOTER */
        .footer { margin-top: 40px;
            text-align: center; color: #94a3b8; font-size: 12px; padding: 20px; border-top: 1px solid #e2e8f0;
        }

        /* MODAL */
        .modal-overlay { display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100;
            justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 650px;
            padding: 30px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: slideIn 0.3s ease; max-height: 90vh;
            overflow-y: auto; }
        
        @keyframes slideIn { from { transform: translateY(20px);
            opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .form-grid { display: grid;
            grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-full { grid-column: span 2;
        }

        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #475569;
        }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;
            margin-bottom: 5px; font-size: 14px; outline: none; transition: border 0.2s; box-sizing: border-box;
        }
        .form-input:focus { border-color: var(--primary);
        }
        .hint { font-size: 12px; color: #94a3b8; margin-bottom: 10px; display: block;
        }

        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; padding: 10px;
            border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; }
        .checkbox-wrapper:hover { background: #f8fafc;
        }
        
        .btn-group { display: flex;
            gap: 10px; margin-top: 20px; grid-column: span 2; }
        .btn-save { flex: 2;
            background: var(--secondary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .btn-cancel { flex: 1; background: transparent; color: #64748b; border: 2px solid #e2e8f0;
            padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-save:hover { background: #0f172a;
        }

        .total-preview { grid-column: span 2; background: #eff6ff; padding: 15px; text-align: center;
            border-radius: 8px; color: var(--primary); font-weight: 800; font-size: 18px; border: 1px solid #bfdbfe; margin-top: 10px;
        }

        #div-otro-depto { animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1;
        } }
        
        /* ESTILO EXTRA PARA CONFIG EXPANDIBLE */
        .config-scroll-area {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 15px;
            border: 1px solid #f1f5f9;
            padding: 10px;
            border-radius: 8px;
        }
        .config-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; background: #f8fafc;
            padding: 10px; border-radius: 8px; position: relative;}
        .config-col-name { flex: 2;
        }
        .config-col-type { flex: 1;
        }
        .config-col-points { flex: 1;
        }
        .btn-delete-item { color: var(--danger); cursor: pointer; border: none; background: transparent; font-size: 16px;
            margin-bottom: 8px;}

        @media print {
            .actions, .btn-group-action, th:last-child, td:last-child, .search-container { display: none !important;
            }
            body { background: white; padding: 0;
            }
            .container { max-width: 100%;
            }
            .card, .chart-box, .table-box { box-shadow: none;
            border: 1px solid #ccc; }
            .footer { display: none;
            }
        }

    </style>
</head>
<body>

    <div class="container">
        
        <div class="header">
            <div>
                <h1>Dep. Investigaci√≥n Aplicada a la Innovaci√≥n</h1>
                <p>M√≥dulo de Gesti√≥n de Puntos para gestores de innovaci√≥n</p>
            </div>
            <div class="actions">
                <button class="btn-config" onclick="abrirConfig()" title="Configuraci√≥n de Puntos">
                    ‚öôÔ∏è
                </button>
                <button class="btn-print" onclick="window.print()">
                    üñ®Ô∏è Imprimir
                </button>
                <button class="btn-main" onclick="abrirModal()">
                 
                    <span>+</span> Nuevo Gestor
                </button>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="card">
                <div class="kpi-title">Total Gestores Activos</div>
                <div class="kpi-number" id="kpi-total">0</div>
 
            </div>
            <div class="card">
                <div class="kpi-title">Puntos Totales (PI)</div>
                <div class="kpi-number" id="kpi-puntos" style="color: var(--primary);">0</div>
            </div>
            <div class="card">
            
                <div class="kpi-title">Top Innovador</div>
                <div class="kpi-number" id="kpi-lider" style="font-size: 24px;
                color: var(--accent);">---</div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-box">
                <div class="chart-header">üèÜ Ranking Global (Puntos PI)</div>
                <div id="chart-points"></div>
            </div>
       
            <div class="chart-box">
                <div class="chart-header" id="chart-header-ideas">üí° Ideas Propias Implementadas</div>
                <div id="chart-ideas"></div> 
            </div>
        </div>

        <div class="table-box">
            <div class="table-header-row">
             
                <div class="table-title">Directorio y Desglose</div>
                <div class="search-container">
                    <input type="text" id="input-search" placeholder="üîç Buscar por nombre o ID..." onkeyup="renderizar()">
                </div>
            </div>
            <table id="main-table">
       
                <thead>
                    <tr id="table-head-row">
                        </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
 
        </div>

        <div class="footer">
            Sistema de Puntos 2026
        </div>

    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-top: 0;
            margin-bottom: 20px; color: var(--secondary);">Registro y C√°lculo de Puntos</h2>
            <form id="form-gestor" onsubmit="guardarDatoLocal(event)" oninput="calcularTotalEnVivo()">
                
                <div class="form-grid">
                    <div>
                        <label 
                        class="form-label">ID Empleado</label>
                        <input type="text" id="input-id" class="form-input" placeholder="Ej: 1045" required>
                    </div>
                    <div>
                        <label class="form-label">Nombre del Colaborador</label>
  
                        <input type="text" id="input-nombre" class="form-input" placeholder="Nombre completo" required>
                    </div>

                    <div class="form-full">
                        <label class="form-label">Direcci√≥n / Departamento</label>
    
                        <select id="input-depto" class="form-input" onchange="verificarOtroDepto()">
                            <option value="">Seleccione una opci√≥n...</option>
                            <optgroup label="DIRECCIONES">
                 
                                <option value="Direcci√≥n Jur√≠dica">Direcci√≥n Jur√≠dica</option>
                                <option value="Direcci√≥n de Planificaci√≥n y Desarrollo">Direcci√≥n de Planificaci√≥n y Desarrollo</option>
                                <option value="Direcci√≥n de Gesti√≥n Humana">Direcci√≥n de Gesti√≥n Humana</option>
  
                                <option value="Direcci√≥n de Comunicaciones">Direcci√≥n de Comunicaciones</option>
                                <option value="Direcci√≥n de TI y Comunicaciones">Direcci√≥n de TI y Comunicaciones</option>
                        
                                <option value="Direcci√≥n de Administraci√≥n y Finanzas">Direcci√≥n de Administraci√≥n y Finanzas</option>
                                <option value="Direcci√≥n de Formaci√≥n Profesional">Direcci√≥n de Formaci√≥n Profesional</option>
                                <option value="Direcci√≥n de Competitividad Empresarial">Direcci√≥n de Competitividad Empresarial</option>
     
                                <option value="Direcci√≥n de Rector√≠a y Regulaci√≥n de Centros">Direcci√≥n de Rector√≠a y Regulaci√≥n de Centros</option>
                                <option value="Direcci√≥n de Innovaci√≥n y Desarrollo">Direcci√≥n de Innovaci√≥n y Desarrollo</option>
                   
                                <option value="Direcci√≥n de Monitoreo, Proyectos y Convenios">Direcci√≥n de Monitoreo, Proyectos y Convenios</option>
                                <option value="Direcci√≥n Regional Metropolitana">Direcci√≥n Regional Metropolitana</option>
                                <option value="Direcci√≥n Regional Oriental">Direcci√≥n Regional Oriental</option>
  
                                <option value="Direcci√≥n Regional Cibao Norte">Direcci√≥n Regional Cibao Norte</option>
                                <option value="Direcci√≥n Regional Cibao Sur">Direcci√≥n Regional Cibao Sur</option>
                        
                                <option value="Direcci√≥n Regional Este">Direcci√≥n Regional Este</option>
                                <option value="Direcci√≥n Regional Sur">Direcci√≥n Regional Sur</option>
                            </optgroup>
                      
                            <optgroup label="DEPARTAMENTOS">
                                <option value="Departamento de Documentos Legales">Departamento de Documentos Legales</option>
                                <option value="Departamento de Planes y Proyectos">Departamento de Planes y Proyectos</option>
             
                                <option value="Departamento de Organizaci√≥n del Trabajo">Departamento de Organizaci√≥n del Trabajo</option>
                                <option value="Departamento de Mercadeo">Departamento de Mercadeo</option>
                                <option value="Departamento de Administraci√≥n de Servicios TIC">Departamento de Administraci√≥n de Servicios TIC</option>
                                <option value="Departamento de Contabilidad">Departamento de Contabilidad</option>
                                <option value="Departamento de Desarrollo Curricular">Departamento de Desarrollo Curricular</option>
                
                                <option value="Departamento de Validaci√≥n y Homologaci√≥n">Departamento de Validaci√≥n y Homologaci√≥n</option>
                                <option value="Departamento de Estrategias Empresariales">Departamento de Estrategias Empresariales</option>
                                <option value="Departamento de Concursos">Departamento de Concursos</option>
                                <option value="Departamento de Litigios">Departamento de Litigios</option>
                                <option value="Departamento de Investigaci√≥n">Departamento de Investigaci√≥n</option>
                         
                                <option value="Departamento de Reclutamiento y Selecci√≥n">Departamento de Reclutamiento y Selecci√≥n</option>
                                <option value="Departamento de Prensa y Relaciones P√∫blicas">Departamento de Prensa y Relaciones P√∫blicas</option>
                                <option value="Departamento de Desarrollo e Implementaci√≥n de Sistemas">Departamento de Desarrollo e Implementaci√≥n de Sistemas</option>
                                <option value="Departamento de Tesorer√≠a">Departamento de Tesorer√≠a</option>
                                <option value="Departamento de Evaluaci√≥n y Acreditaci√≥n">Departamento de Evaluaci√≥n y Acreditaci√≥n</option>
                  
                                <option value="Departamento de Admisi√≥n y Empleo">Departamento de Admisi√≥n y Empleo</option>
                                <option value="Departamento de Formaci√≥n y Programas">Departamento de Formaci√≥n y Programas</option>
                                <option value="Departamento de Acreditaci√≥n de Centros">Departamento de Acreditaci√≥n de Centros</option>
                                <option value="Departamento de Desarrollo Institucional">Departamento de Desarrollo Institucional</option>
                                <option value="Departamento de Capacitaci√≥n y ED">Departamento de Capacitaci√≥n y ED</option>
               
                                <option value="Departamento de Operaciones TIC">Departamento de Operaciones TIC</option>
                                <option value="Departamento de Servicios Generales">Departamento de Servicios Generales</option>
                                <option value="Departamento de Investigaci√≥n y Producci√≥n Did√°ctica">Departamento de Investigaci√≥n y Producci√≥n Did√°ctica</option>
                                <option value="Departamento de Fiscalizaci√≥n de Centros">Departamento de Fiscalizaci√≥n de Centros</option>
                                <option value="Departamento de Compensaci√≥n">Departamento de Compensaci√≥n</option>
                
                                <option value="Departamento de Seguridad y Monitoreo TIC">Departamento de Seguridad y Monitoreo TIC</option>
                                <option value="Departamento de Compras y Contrataciones">Departamento de Compras y Contrataciones</option>
                                
                                <option value="Departamento de Ingresos">Departamento de Ingresos</option>
                                <option value="Departamento de Seguridad">Departamento de Seguridad</option>
                                <option value="Departamento de Investigaci√≥n Aplicada a la Innovaci√≥n">Departamento de Investigaci√≥n Aplicada a la Innovaci√≥n</option>
             
                            </optgroup>
                            <option value="OTRO" style="font-weight: bold;
                            color: var(--primary);">OTRO (Especifique Manualmente)</option>
                        </select>

                        <div id="div-otro-depto" style="display: none;
                        margin-top: 10px;">
                            <label class="form-label" style="font-size: 12px;
                            color: var(--primary);">Especifique el nombre del √°rea:</label>
                            <input type="text" id="input-otro-depto" class="form-input" placeholder="Escriba el nombre aqu√≠...">
                        </div>
                    </div>

                
                    <div class="form-full" style="border-top: 1px solid #e2e8f0; margin-top: 10px;
                    padding-top: 10px;">
                        <label class="form-label" style="color: var(--primary);">ASIGNACI√ìN DE PUNTOS (Actividades Din√°micas)</label>
                    </div>

                    <div id="dynamic-form-fields" class="form-full">
                        </div>

  
                    <div class="total-preview">
                        Total Calculado: <span id="preview-total">0</span> PI
                    </div>

                    <div class="btn-group">
            
                        <button type="button" class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                        <button type="submit" class="btn-save" id="btn-save-text">Guardar Registro</button>
                    </div>
                </div>
            </form>
        </div>
 
    </div>

    <div class="modal-overlay" id="modal-config">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display:flex;
            justify-content:space-between; align-items:center;">
                <h2 style="margin-top: 0;
                color: var(--secondary);">‚öôÔ∏è Configuraci√≥n de Normativa</h2>
                <button type="button" class="btn-main" onclick="agregarActividadConfig()" style="font-size: 12px;
                padding: 8px 15px;">+ Agregar Actividad</button>
            </div>
            <p style="font-size: 13px;
            color: #64748b; margin-bottom: 20px;">
                Gestione las actividades. Use la barra lateral para ver m√°s si hay muchas.
            </p>
            
            <form onsubmit="guardarConfig(event)">
                
                
                <div class="config-scroll-area" id="config-items-container">
                    </div>

                <div class="btn-group">
                    <button type="button" class="btn-cancel" onclick="cerrarConfig()">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar Cambios</button>
               
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN INICIAL (DIN√ÅMICA) ---
        let configNormativa = [
            { id: 'act_1', nombre: "Programa de Formaci√≥n", tipo: 'check', valor: 400 },
            { id: 'act_2', nombre: "Por Taller Asistido", tipo: 'number', valor: 200 },
            { id: 'act_3', nombre: "Por Acompa√±amiento", tipo: 'number', valor: 150 },
            { id: 'act_4', nombre: "Por Idea Propia", tipo: 'number', valor: 400 },
            { id: 'act_5', nombre: "Por Evento Anual", tipo: 'check', valor: 500 }
        ];
        
        // --- DATOS INICIALES ---
        // Se agrega la propiedad activo: true por defecto
        let datos = [
            { id: "1045", name: "Jorge Tonos", depto: "Direcci√≥n de TI y Comunicaciones", valores: { 'act_1': true, 'act_2': 3, 'act_3': 2, 'act_4': 2, 'act_5': true }, points: 0, activo: true },
            { id: "2033", name: "Iris Cesa", depto: "Direcci√≥n de Gesti√≥n Humana", valores: { 'act_1': true, 'act_2': 2, 'act_3': 1, 'act_4': 1, 'act_5': false }, points: 0, activo: true },
            { id: "3012", name: "Rosanny Contreras", depto: "Departamento de Operaciones TIC", valores: { 'act_1': true, 'act_2': 3, 'act_3': 4, 'act_4': 0, 'act_5': true }, points: 0, activo: true }
        ];
        
        let indiceEdicion = -1;

        // --- C√ÅLCULO DIN√ÅMICO ---
        function calcularPuntos(gestorValores) {
            let total = 0;
            configNormativa.forEach(item => {
                const val = gestorValores[item.id];
                if (item.tipo === 'check') {
                    if (val === true || val === 'true') total += item.valor;
                } else {
                    total += (parseInt(val) || 0) * item.valor;
                }
            });
            return total;
        }

        // --- RENDERIZADO GLOBAL ---
        function renderizar() {
            // Filtrado
            const termino = document.getElementById('input-search') ?
            document.getElementById('input-search').value.toLowerCase() : "";
            
            // Recalcular puntos
            datos.forEach(d => {
                if(!d.valores) d.valores = {};
                if(d.activo === undefined) d.activo = true; // Asegurar propiedad
                d.points = calcularPuntos(d.valores);
            });
            
            // Ordenamos todos para la tabla
            datos.sort((a, b) => b.points - a.points);

            const datosFiltrados = datos.filter(d => 
                d.name.toLowerCase().includes(termino) || 
                d.id.includes(termino) ||
                d.depto.toLowerCase().includes(termino)
            );

            // --- L√ìGICA SOLO ACTIVOS (Para Rankings y KPIs) ---
            const datosActivos = datos.filter(d => d.activo !== false);

            // KPIs (Usando solo activos)
            document.getElementById('kpi-total').textContent = datosActivos.length;
            const totalGlobal = datosActivos.reduce((sum, item) => sum + item.points, 0);
            document.getElementById('kpi-puntos').textContent = totalGlobal.toLocaleString();
            document.getElementById('kpi-lider').textContent = datosActivos.length > 0 ?
            datosActivos[0].name : "---";

            // Gr√°fica 1: Ranking Global (Solo Activos)
            const chartPoints = document.getElementById('chart-points');
            chartPoints.innerHTML = "";
            const maxPoints = Math.max(...datosActivos.map(d => d.points)) || 100;
            
            datosActivos.slice(0, 10).forEach(d => {
                const percent = (d.points / maxPoints) * 100;
                chartPoints.innerHTML += `
                    <div class="bar-container">
                        <div class="bar-name">${d.name}</div>
                        <div class="bar-bg">
                            <div class="bar-fill" style="width: ${percent}%; background-color: var(--primary);">
                                ${d.points}
                            </div>
                        </div>
                    </div>
                `;
            });

            // Gr√°fica 2: Ideas (Solo Activos)
            const chartIdeas = document.getElementById('chart-ideas');
            chartIdeas.innerHTML = "";
            
            // Buscamos la actividad correcta
            const ideaActivity = configNormativa.find(c => c.nombre.includes("Idea")) ||
            configNormativa.find(c => c.tipo === 'number');

            if (ideaActivity) {
                document.getElementById('chart-header-ideas').textContent = `üí° ${ideaActivity.nombre}`;
                
                // Calcular m√°ximo usando solo activos
                const maxVal = Math.max(...datosActivos.map(d => parseInt(d.valores[ideaActivity.id]) || 0)) || 5;

                datosActivos.slice(0, 10).forEach(d => {
                    const val = parseInt(d.valores[ideaActivity.id]) || 0;
                    const percent = (val / maxVal) * 100;
                    
                    if(val >= 0) {
                        chartIdeas.innerHTML += `
                            <div class="bar-container">
                                <div class="bar-name">${d.name}</div>
                                <div class="bar-bg">
                                    <div class="bar-fill" style="width: ${percent}%; background-color: var(--accent);">
                                         ${val}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            } else {
                chartIdeas.innerHTML = "<p style='color:#999; font-size:12px; text-align:center;'>No se encontr√≥ actividad de 'Ideas' configurada.</p>";
            }


            // TABLA: Generar Cabeceras Din√°micas
            const theadRow = document.getElementById('table-head-row');
            let headersHTML = `<th>ID</th><th>Nombre</th><th>Depto</th>`;
            
            configNormativa.forEach(item => {
                let shortName = item.nombre.length > 10 ? item.nombre.substring(0, 8) + '.' : item.nombre;
                headersHTML += `<th title="${item.nombre}" style="text-align: center;">${shortName}</th>`;
            });
            headersHTML += `<th>Total PI</th><th style="text-align: center;">Acciones</th>`;
            theadRow.innerHTML = headersHTML;

            // TABLA: Generar Filas
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            
            if (datosFiltrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${5 + configNormativa.length}" style="text-align:center; padding: 20px; color: #94a3b8;">No se encontraron resultados</td></tr>`;
            } else {
                datosFiltrados.forEach((d) => {
                    const indexOriginal = datos.findIndex(item => item.id === d.id);
                    const isInactivo = d.activo === false;
                    const rowClass = isInactivo ? 'class="tr-inactive"' : '';
                    
                    // Configuraci√≥n del bot√≥n Toggle
                    const iconToggle = isInactivo ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
                    const titleToggle = isInactivo ? 'Reactivar' : 'Inactivar';
                    
                    let rowHTML = `
                        <tr ${rowClass}>
                            <td><span class="id-cell">${d.id}</span></td>
                            <td style="font-weight: 600;">${d.name} ${isInactivo ? '(Inactivo)' : ''}</td>
                            <td><span class="badge" title="${d.depto}">${d.depto}</span></td>
                    `;

                    configNormativa.forEach(item => {
                        const val = d.valores[item.id];
                        let displayVal = '-';
                        if (item.tipo === 'check') {
                            displayVal = val ? '‚úÖ' : '-';
                        } else {
                            displayVal = val > 0 ? val : '-';
                        }
                        rowHTML += `<td style="text-align: center;">${displayVal}</td>`;
                    });
                    
                    rowHTML += `
                            <td style="color: var(--primary); font-weight: 800;">${d.points}</td>
                            <td style="text-align: center;">
                                <div class="btn-group-action">
                                    <button class="btn-icon btn-edit" onclick="cargarEdicion(${indexOriginal})" title="Modificar">‚úèÔ∏è</button>
                                    <button class="btn-icon btn-toggle" onclick="toggleEstado(${indexOriginal})" title="${titleToggle}">${iconToggle}</button>
                                    <button class="btn-icon btn-delete" onclick="eliminarGestor(${indexOriginal})" title="Eliminar">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += rowHTML;
                });
            }
        }

        // --- GESTI√ìN DE CONFIGURACI√ìN ---
        function abrirConfig() {
            renderConfigItems();
            document.getElementById('modal-config').style.display = 'flex';
        }

        function cerrarConfig() {
            document.getElementById('modal-config').style.display = 'none';
        }

        function renderConfigItems() {
            const container = document.getElementById('config-items-container');
            container.innerHTML = '';

            configNormativa.forEach((item, index) => {
                container.innerHTML += `
                    <div class="config-row" id="conf-row-${index}">
                        <div class="config-col-name">
                            <label 
                            class="form-label" style="font-size:11px">Nombre Actividad</label>
                            <input type="text" class="form-input" value="${item.nombre}" onchange="actualizarConfigTemp(${index}, 'nombre', this.value)">
                        </div>
                        <div class="config-col-type">
               
                            <label class="form-label" style="font-size:11px">Tipo</label>
                            <select class="form-input" onchange="actualizarConfigTemp(${index}, 'tipo', this.value)">
                                <option value="check" ${item.tipo === 'check' ? 'selected' : ''}>Si/No</option>
                                <option value="number" ${item.tipo === 'number' ? 'selected' : ''}>Cantidad</option>
                            </select>
                        </div>
                     
                        <div class="config-col-points">
                            <label class="form-label" style="font-size:11px">Puntos</label>
                            <input type="number" class="form-input" value="${item.valor}" onchange="actualizarConfigTemp(${index}, 'valor', this.value)">
                        </div>
        
                        <button type="button" class="btn-delete-item" onclick="eliminarActividadConfig(${index})" title="Eliminar Actividad">
                            &times;
                        </button>
                    </div>
                `;
            });
        }

        function agregarActividadConfig() {
            const newId = 'act_' + Date.now();
            configNormativa.push({ id: newId, nombre: "Nueva Actividad", tipo: 'number', valor: 0 });
            renderConfigItems(); 
            const container = document.getElementById('config-items-container');
            setTimeout(() => container.scrollTop = container.scrollHeight, 100);
        }

        function eliminarActividadConfig(index) {
            if(confirm("¬øEliminar esta actividad? Se perder√°n los datos asociados en futuros registros.")) {
                configNormativa.splice(index, 1);
                renderConfigItems();
            }
        }

        function actualizarConfigTemp(index, field, value) {
            if (field === 'valor') value = parseInt(value) || 0;
            configNormativa[index][field] = value;
        }

        function guardarConfig(e) {
            e.preventDefault();
            renderizar();
            cerrarConfig();
            alert("¬°Configuraci√≥n actualizada!");
        }

        // --- RENDERIZAR FORMULARIO DE REGISTRO DIN√ÅMICO ---
        function renderFormFields(valoresActuales = {}) {
            const container = document.getElementById('dynamic-form-fields');
            container.innerHTML = '';

            configNormativa.forEach(item => {
                const val = valoresActuales[item.id]; 

                let html = `<div style="margin-bottom: 12px;">`;
                
                if (item.tipo === 'check') {
                  
                    const checked = (val === true || val === 'true') ? 'checked' : '';
                    html += `
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="field_${item.id}" onchange="calcularTotalEnVivo()" ${checked}>
      
                            <span>${item.nombre} <strong style="color:var(--primary)">(+${item.valor} PI)</strong></span>
                        </label>
                    `;
                } else {
             
                    const numVal = val || '';
                    html += `
                        <label class="form-label">${item.nombre}</label>
                        <input type="number" id="field_${item.id}" class="form-input" placeholder="0" min="0" value="${numVal}" oninput="calcularTotalEnVivo()">
          
                        <span class="hint">* ${item.valor} PI por unidad</span>
                    `;
                }
                html += `</div>`;
                container.innerHTML += html;
            });
        }

        // --- L√ìGICA DEPARTAMENTOS ---
        function verificarOtroDepto() {
            const select = document.getElementById('input-depto');
            const divOtro = document.getElementById('div-otro-depto');
            const inputOtro = document.getElementById('input-otro-depto');

            if (select.value === 'OTRO') {
                divOtro.style.display = 'block';
                inputOtro.setAttribute('required', 'true');
            } else {
                divOtro.style.display = 'none';
                inputOtro.removeAttribute('required');
                inputOtro.value = ''; 
            }
        }

        // --- FUNCIONES FORMULARIO PRINCIPAL ---
        function abrirModal() { 
            indiceEdicion = -1;
            document.getElementById('form-gestor').reset();
            verificarOtroDepto(); 
            renderFormFields({});
            
            document.getElementById('modal-title').textContent = "Registrar Nuevo Gestor";
            document.getElementById('btn-save-text').textContent = "Guardar Registro";
            document.getElementById('input-id').disabled = false; 
            document.getElementById('preview-total').textContent = "0";
            document.getElementById('modal').style.display = 'flex';
        }

        function cargarEdicion(index) {
            // Verificar si est√° activo
            if (datos[index].activo === false) {
                alert("El gestor est√° INACTIVO. Debe reactivarlo para poder editar sus datos.");
                return;
            }

            indiceEdicion = index;
            const gestor = datos[index];

            document.getElementById('input-id').value = gestor.id;
            document.getElementById('input-nombre').value = gestor.name;
            
            const select = document.getElementById('input-depto');
            let found = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === gestor.depto) found = true;
            }

            if (found) {
                select.value = gestor.depto;
            } else {
                select.value = 'OTRO';
                document.getElementById('input-otro-depto').value = gestor.depto;
            }
            verificarOtroDepto(); 

            renderFormFields(gestor.valores || {});
            document.getElementById('modal-title').textContent = "Modificar Datos";
            document.getElementById('btn-save-text').textContent = "Guardar Cambios";
            document.getElementById('input-id').disabled = true; 
            
            calcularTotalEnVivo();
            document.getElementById('modal').style.display = 'flex';
        }

        function guardarDatoLocal(e) {
            e.preventDefault();
            const idInput = document.getElementById('input-id').value;
            
            const select = document.getElementById('input-depto');
            let departamentoFinal = select.value;
            if (departamentoFinal === 'OTRO') {
                departamentoFinal = document.getElementById('input-otro-depto').value.trim();
                if (!departamentoFinal) {
                    alert("Por favor especifique el nombre del departamento.");
                    return;
                }
            }

            let nuevosValores = {};
            configNormativa.forEach(item => {
                const element = document.getElementById(`field_${item.id}`);
                if (item.tipo === 'check') {
                    nuevosValores[item.id] = element.checked;
                } else {
                    nuevosValores[item.id] = parseInt(element.value) || 0;
                }
            });

            // Preservamos el estado activo si se edita, o true si es nuevo
            let estadoActual = true;
            if (indiceEdicion !== -1) {
                estadoActual = datos[indiceEdicion].activo;
            }

            const gestorFormulario = {
                id: idInput,
                name: document.getElementById('input-nombre').value,
                depto: departamentoFinal, 
                valores: nuevosValores, 
                points: 0,
                activo: estadoActual // Mantenemos estado
            };

            if (indiceEdicion === -1) {
                if(datos.find(d => d.id === idInput)) {
                    alert("Error: El ID " + idInput + " ya existe.");
                    return;
                }
                datos.push(gestorFormulario);
            } else {
                datos[indiceEdicion] = gestorFormulario;
            }

            renderizar();
            cerrarModal();
        }

        function calcularTotalEnVivo() {
            let tempValores = {};
            configNormativa.forEach(item => {
                const element = document.getElementById(`field_${item.id}`);
                if (element) {
                    if (item.tipo === 'check') {
                        tempValores[item.id] = element.checked;
                    } else {
                        tempValores[item.id] = parseInt(element.value) || 0;
                    }
                }
            });
            document.getElementById('preview-total').textContent = calcularPuntos(tempValores).toLocaleString();
        }

        function eliminarGestor(index) {
            if (confirm("¬øEst√°s seguro de eliminar este registro?")) {
                datos.splice(index, 1);
                renderizar();
            }
        }

        // --- NUEVA FUNCI√ìN: INACTIVAR/ACTIVAR ---
        function toggleEstado(index) {
            // Cambiar estado booleano
            datos[index].activo = !datos[index].activo;
            
            // Mensaje opcional para confirmar acci√≥n (puedes quitarlo si prefieres que sea directo)
            /* if(datos[index].activo) alert("Gestor reactivado exitosamente.");
            else alert("Gestor inactivado. No aparecer√° en los rankings.");
            */
            
            renderizar();
        }

        function cerrarModal() { 
            document.getElementById('modal').style.display = 'none';
            indiceEdicion = -1;
        }

        // Inicializar
        renderizar();
    </script>
</body>
</html>