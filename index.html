
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Puntos 2026</title>
    <style>
        /* ESTILOS DE SEGURIDAD */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 320px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 16px; text-align: center; }
        
        /* BOTONES DE LOGIN */
        .login-btn { width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: transform 0.1s; margin-bottom: 10px; }
        .login-btn:active { transform: scale(0.96); } 
        .login-btn:disabled { background: #94a3b8; cursor: wait; transform: none; }

        /* BOT√ìN DE GESTOR (INVITADO) - NUEVO ESTILO */
        .guest-btn { width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .guest-btn:hover { background: #059669; }
        .guest-btn:active { transform: scale(0.96); }

        /* LOADER (Cargando) */
        #loader-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:5000; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom:10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ESTILOS DEL PROGRAMA */
        :root { --primary: #2563eb; --secondary: #1e293b; --accent: #10b981; --bg: #f1f5f9; --card: #ffffff; --danger: #ef4444; --edit: #f59e0b; --inactive: #64748b; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--secondary); margin: 0; padding: 20px; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1280px; margin: 0 auto; width: 100%; flex: 1; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 30px; border-left: 5px solid var(--primary); }
        .header h1 { margin: 0; font-size: 22px; color: var(--secondary); text-transform: uppercase; }
        .actions { display: flex; gap: 10px; }
        .btn-main, .btn-print, .btn-config { padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; border:none; display:flex; align-items:center; gap:8px; color:white;}
        .btn-main { background: var(--primary); } .btn-print { background: var(--secondary); } .btn-config { background: #cbd5e1; color:#334155; }
        .kpi-grid, .charts-section { display: grid; gap: 20px; margin-bottom: 30px; }
        .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
        .charts-section { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
        .card, .chart-box, .table-box { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .kpi-number { font-size: 36px; font-weight: 800; margin-top: 10px; }
        .table-box { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; padding: 18px; font-size: 11px; text-transform: uppercase; color: #64748b; }
        td { padding: 18px; border-bottom: 1px solid #f1f5f9; }
        .tr-inactive { background-color: #f1f5f9 !important; opacity: 0.6; filter: grayscale(100%); }
        .badge { background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .id-cell { font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0; }
        .btn-group-action { display: flex; gap: 8px; justify-content: center; }
        .btn-icon { border: 1px solid #e2e8f0; background: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
        .btn-edit { color: var(--primary); } .btn-delete { color: var(--danger); } .btn-toggle { color: var(--edit); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 650px; padding: 30px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .form-full { grid-column: span 2; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; grid-column: span 2; }
        .btn-save { flex: 2; background: var(--secondary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
        .btn-cancel { flex: 1; border: 2px solid #e2e8f0; background: transparent; padding: 12px; border-radius: 8px; cursor: pointer; }
        .config-scroll-area { max-height: 300px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #f1f5f9; padding: 10px; }
        .config-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; }
        .bar-container { display: flex; align-items: center; margin-bottom: 15px; font-size: 14px; }
        .bar-bg { flex: 1; background: #f1f5f9; height: 28px; border-radius: 6px; position: relative; overflow: hidden; margin-left:10px;}
        .bar-fill { height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-weight: bold; font-size: 12px; }
        
        /* ESTILO DEL INPUT DE B√öSQUEDA AZUL */
        #input-search { border: 2px solid var(--primary); background-color: #eff6ff; color: #1e3a8a; padding: 10px; border-radius: 6px; width: 250px; outline: none; }
        #input-search:focus { box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }

        /* CLASE PARA OCULTAR ELEMENTOS A LOS GESTORES */
        .oculto-para-gestor { display: none !important; }

        @media print { .actions, .btn-group-action, .search-container, #login-screen { display: none !important; } }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="spinner"></div>
        <div style="font-weight:bold; color:#1e293b" id="loader-text">Conectando con Google Sheets...</div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:#2563eb; margin-top:0;">Acceso T√©cnico</h2>
            <p style="color:#64748b; font-size:14px; margin-bottom:20px;">Sistema de Gesti√≥n 2026</p>
            
            <input type="text" id="user-input" class="login-input" placeholder="Usuario">
            <input type="password" id="pass-input" class="login-input" placeholder="Contrase√±a">
            
            <button onclick="iniciarSesion()" id="btn-login" class="login-btn">INGRESAR COMO ADMIN</button>
            
            <div style="margin: 15px 0; color: #cbd5e1; font-size: 12px;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ O ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
            
            <button onclick="entrarComoGestor()" class="guest-btn">
                üëã Soy Gestor (Ver Avances)
            </button>
            
            <p id="msg-error" style="color:#ef4444; font-size:12px; margin-top:15px; min-height:15px;"></p>
        </div>
    </div>

    <div id="sistema-principal" style="display:none;">
        <div class="container">
            <div class="header">
                <div>
                    <h1>Dep. Investigaci√≥n Aplicada a la Innovaci√≥n</h1>
                    <p>M√≥dulo de Gesti√≥n de Puntos | <span id="nombre-tecnico" style="color:#3b82f6; font-weight:800; font-size: 1.1em;">Acceso Seguro</span></p>
                </div>
                <div class="actions">
                    <button id="btn-config-global" class="btn-config" onclick="abrirConfig()">‚öôÔ∏è</button>
                    <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                    <button id="btn-nuevo-global" class="btn-main" onclick="abrirModal()"><span>+</span> Nuevo Gestor</button>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="card"><div class="kpi-title">Gestores Activos</div><div class="kpi-number" id="kpi-total">0</div></div>
                <div class="card"><div class="kpi-title">Puntos Totales</div><div class="kpi-number" id="kpi-puntos" style="color:var(--primary);">0</div></div>
                <div class="card"><div class="kpi-title">Top Innovador</div><div class="kpi-number" id="kpi-lider" style="font-size:24px; color:var(--accent);">---</div></div>
            </div>

            <div class="charts-section">
                <div class="chart-box"><div class="chart-header">üèÜ Ranking Global</div><div id="chart-points"></div></div>
                <div class="chart-box"><div class="chart-header" id="chart-header-ideas">üí° Ideas</div><div id="chart-ideas"></div></div>
            </div>

            <div class="table-box">
                <div class="table-header-row">
                    <div class="table-title">Directorio</div>
                    <div class="search-container">
                        <input type="text" id="input-search" placeholder="üîç Buscar..." onkeyup="renderizar()">
                    </div>
                </div>
                <table id="main-table"><thead><tr id="table-head-row"></tr></thead><tbody id="table-body"></tbody></table>
            </div>
            <div class="footer" style="margin-top:40px; text-align:center; color:#94a3b8; font-size:12px;">Sistema conectado a Google Sheets</div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-top:0; color:var(--secondary);">Gesti√≥n de Empleado</h2>
            <form id="form-gestor" onsubmit="guardarGestor(event)" oninput="calcularTotalEnVivo()">
                <div class="form-grid">
                    <div><label class="form-label">ID Empleado</label><input type="text" id="input-id" class="form-input" required></div>
                    <div><label class="form-label">Nombre</label><input type="text" id="input-nombre" class="form-input" required></div>
                    <div class="form-full">
                        <label class="form-label">Departamento</label>
                        <select id="input-depto" class="form-input" onchange="verificarOtroDepto()">
                            <option value="">Seleccionar...</option>
                            <option value="Direcci√≥n TI">Direcci√≥n TI</option>
                            <option value="RRHH">RRHH</option>
                            <option value="Innovaci√≥n">Innovaci√≥n</option>
                            <option value="OTRO" style="font-weight:bold; color:blue;">OTRO (Escribir manual)</option>
                        </select>
                        <input type="text" id="input-otro-depto" class="form-input" style="display:none; margin-top:5px;" placeholder="Especifique el √°rea...">
                    </div>
                    <div class="form-full" style="border-top:1px solid #eee; margin-top:10px; padding-top:10px; font-weight:bold; color:var(--primary);">Actividades</div>
                    <div id="dynamic-form-fields" class="form-full"></div>
                    <div class="total-preview">Total: <span id="preview-total">0</span> PI</div>
                    <div class="btn-group">
                        <button type="button" class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                        <button type="submit" class="btn-save" id="btn-save-text">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-config">
        <div class="modal-content" style="max-width:700px;">
            <div style="display:flex; justify-content:space-between;">
                <h2 style="margin:0;">‚öôÔ∏è Configuraci√≥n</h2>
                <button type="button" class="btn-main" onclick="agregarActividadConfig()" style="font-size:12px;">+ Agregar</button>
            </div>
            <form onsubmit="guardarConfigRemoto(event)">
                <div class="config-scroll-area" id="config-items-container"></div>
                <div class="btn-group">
                    <button type="button" class="btn-cancel" onclick="cerrarConfig()">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==========================================
        // üîó URL DE TU SCRIPT DE GOOGLE
        // ==========================================
        const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyIOmYwLepD1NT9NisyM6GCPW1UIn_vljL_uiZTAkAJUbOZrd78-z74ggfiwHN0cAJB/exec";

        // Variables Globales
        let datos = [];
        let configNormativa = [];
        let indiceEdicion = -1;
        let esModoLectura = false; // Nueva variable para controlar permisos

        // --- NUEVA FUNCI√ìN: ENTRAR COMO GESTOR ---
        function entrarComoGestor() {
            esModoLectura = true; // Activar modo lectura
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('sistema-principal').style.display = 'block';
            document.getElementById('nombre-tecnico').textContent = "Vista de Gestor (Solo Lectura)";
            document.getElementById('nombre-tecnico').style.color = "#10b981"; // Color verde para indicar modo gestor
            
            // Ocultar botones administrativos globales
            document.getElementById('btn-config-global').style.display = 'none';
            document.getElementById('btn-nuevo-global').style.display = 'none';

            cargarDatosDelServidor(); 
        }

        // --- CONEXI√ìN: LOGIN ADMIN ---
        function iniciarSesion() {
            const user = document.getElementById('user-input').value;
            const pass = document.getElementById('pass-input').value;
            if(!URL_GOOGLE.includes("script.google.com")) { alert("Falta configurar la URL del script."); return; }
            
            mostrarLoader("Validando credenciales...");
            
            fetch(URL_GOOGLE, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ accion: "login", usuario: user, pass: pass })
            })
            .then(r => r.json())
            .then(res => {
                if(res.validado) {
                    esModoLectura = false; // Es Admin
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('sistema-principal').style.display = 'block';
                    document.getElementById('nombre-tecnico').textContent = "Bienvenido " + res.nombre;
                    document.getElementById('nombre-tecnico').style.color = "#3b82f6"; // Color azul original

                    // Mostrar botones por si acaso estaban ocultos
                    document.getElementById('btn-config-global').style.display = 'flex';
                    document.getElementById('btn-nuevo-global').style.display = 'flex';

                    cargarDatosDelServidor(); 
                } else {
                    ocultarLoader();
                    document.getElementById('msg-error').textContent = "Credenciales incorrectas.";
                }
            })
            .catch(e => { ocultarLoader(); alert("Error de conexi√≥n: " + e); });
        }

        // --- CONEXI√ìN: CARGAR TODO ---
        function cargarDatosDelServidor() {
            mostrarLoader("Descargando base de datos...");
            fetch(URL_GOOGLE, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ accion: "leer_todo" })
            })
            .then(r => r.json())
            .then(res => {
                datos = res.gestores;
                configNormativa = res.config;
                // Recalcular puntos
                datos.forEach(d => d.points = calcularPuntos(d.valores));
                renderizar();
                ocultarLoader();
            })
            .catch(e => { ocultarLoader(); alert("Error cargando datos: " + e); });
        }

        // --- CONEXI√ìN: GUARDAR GESTOR ---
        function guardarGestor(e) {
            e.preventDefault();
            if(esModoLectura) return; // Seguridad extra

            const idInput = document.getElementById('input-id').value;
            let depto = document.getElementById('input-depto').value;
            if (depto === 'OTRO') depto = document.getElementById('input-otro-depto').value.trim();

            let valores = {};
            configNormativa.forEach(item => {
                const el = document.getElementById(`field_${item.id}`);
                valores[item.id] = item.tipo === 'check' ? el.checked : (parseInt(el.value)||0);
            });

            if (indiceEdicion === -1 && datos.find(d => d.id == idInput)) {
                alert("Error: El ID ya existe."); return;
            }

            let estado = true;
            if(indiceEdicion !== -1) estado = datos[indiceEdicion].activo;

            const gestorObj = { id: idInput, name: document.getElementById('input-nombre').value, depto: depto, valores: valores, activo: estado };

            mostrarLoader("Guardando en la nube...");
            fetch(URL_GOOGLE, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ accion: "guardar_gestor", gestor: gestorObj })
            })
            .then(r => r.json())
            .then(res => {
                if(res.exito) {
                    cerrarModal();
                    cargarDatosDelServidor(); 
                }
            });
        }

        // --- CONEXI√ìN: ELIMINAR ---
        function eliminarGestor(index) {
            if(esModoLectura) return; // Seguridad
            if(!confirm("¬øSeguro que deseas eliminar este registro de la base de datos?")) return;
            const idEliminar = datos[index].id;
            
            mostrarLoader("Eliminando...");
            fetch(URL_GOOGLE, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ accion: "eliminar_gestor", id: idEliminar })
            })
            .then(r => r.json())
            .then(res => {
                if(res.exito) cargarDatosDelServidor();
            });
        }

        // --- CONEXI√ìN: INACTIVAR/ACTIVAR ---
        function toggleEstado(index) {
            if(esModoLectura) return; // Seguridad
            const idTarget = datos[index].id;
            mostrarLoader("Actualizando estado...");
            fetch(URL_GOOGLE, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ accion: "toggle_estado", id: idTarget })
            })
            .then(r => r.json())
            .then(res => {
                if(res.exito) cargarDatosDelServidor();
            });
        }

        // --- CONEXI√ìN: GUARDAR CONFIG ---
        function guardarConfigRemoto(e) {
            e.preventDefault();
            if(esModoLectura) return; // Seguridad
            mostrarLoader("Actualizando configuraci√≥n...");
            fetch(URL_GOOGLE, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ accion: "guardar_config", config: configNormativa })
            })
            .then(r => r.json())
            .then(res => {
                if(res.exito) { cerrarConfig(); cargarDatosDelServidor(); }
            });
        }

        // --- FUNCIONES AUXILIARES (L√≥gica Visual) ---
        function mostrarLoader(txt) { document.getElementById('loader-overlay').style.display='flex'; document.getElementById('loader-text').textContent = txt; }
        function ocultarLoader() { document.getElementById('loader-overlay').style.display='none'; }

        function calcularPuntos(vals) {
            let total = 0;
            configNormativa.forEach(c => {
                const v = vals[c.id];
                if(c.tipo === 'check') { if(v === true || v === 'true') total += c.valor; }
                else { total += (parseInt(v)||0) * c.valor; }
            });
            return total;
        }

        function renderizar() {
            const term = document.getElementById('input-search').value.toLowerCase();
            const activos = datos.filter(d => d.activo);
            
            // KPIs
            document.getElementById('kpi-total').textContent = activos.length;
            document.getElementById('kpi-puntos').textContent = activos.reduce((s, d) => s + d.points, 0).toLocaleString();
            
            // TOP INNOVADOR (CORREGIDO PARA EMPATES)
            if(activos.length > 0) {
                const maxPts = Math.max(...activos.map(d => d.points));
                const lideres = activos.filter(d => d.points === maxPts).map(d => d.name);
                document.getElementById('kpi-lider').textContent = lideres.join(" / ");
                document.getElementById('kpi-lider').style.fontSize = lideres.length > 1 ? "22px" : "24px";
            } else {
                document.getElementById('kpi-lider').textContent = "---";
            }

            // Gr√°ficas
            renderCharts(activos);

            // Tabla
            const thead = document.getElementById('table-head-row');
            let ths = `<th>ID</th><th>Nombre</th><th>Depto</th>`;
            configNormativa.forEach(c => ths += `<th style="text-align:center">${c.nombre.substring(0,10)}</th>`);
            ths += `<th>Total</th><th style="text-align:center" class="${esModoLectura ? 'oculto-para-gestor' : ''}">Acciones</th>`;
            thead.innerHTML = ths;

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            
            const filtrados = datos.filter(d => d.name.toLowerCase().includes(term) || String(d.id).includes(term));
            
            filtrados.forEach((d) => {
                const idx = datos.indexOf(d);
                const inactiveClass = !d.activo ? 'tr-inactive' : '';
                let tr = `<tr class="${inactiveClass}">
                    <td><span class="id-cell">${d.id}</span></td>
                    <td>${d.name} ${!d.activo ? '(Inactivo)' : ''}</td>
                    <td><span class="badge">${d.depto}</span></td>`;
                
                configNormativa.forEach(c => {
                    const val = d.valores[c.id];
                    tr += `<td style="text-align:center">${c.tipo==='check' ? (val?'‚úÖ':'-') : (val||'-')}</td>`;
                });

                // L√ìGICA DE OCULTAR BOTONES PARA GESTOR
                const claseAcciones = esModoLectura ? 'oculto-para-gestor' : '';

                tr += `<td style="font-weight:bold; color:var(--primary)">${d.points}</td>
                    <td style="text-align:center" class="${claseAcciones}">
                        <div class="btn-group-action">
                            <button class="btn-icon btn-edit" onclick="cargarEdicion(${idx})">‚úèÔ∏è</button>
                            <button class="btn-icon btn-toggle" onclick="toggleEstado(${idx})">${d.activo?'‚è∏Ô∏è':'‚ñ∂Ô∏è'}</button>
                            <button class="btn-icon btn-delete" onclick="eliminarGestor(${idx})">üóëÔ∏è</button>
                        </div>
                    </td></tr>`;
                tbody.innerHTML += tr;
            });
        }

        function renderCharts(activos) {
            const c1 = document.getElementById('chart-points'); c1.innerHTML="";
            const max = Math.max(...activos.map(d=>d.points)) || 100;
            activos.slice(0,10).forEach(d => {
                c1.innerHTML += `<div class="bar-container"><div class="bar-name">${d.name}</div><div class="bar-bg"><div class="bar-fill" style="width:${(d.points/max)*100}%; background:var(--primary)">${d.points}</div></div></div>`;
            });

            const c2 = document.getElementById('chart-ideas'); c2.innerHTML="";
            const actIdea = configNormativa.find(c => c.tipo === 'number');
            if(actIdea) {
                document.getElementById('chart-header-ideas').textContent = "üí° " + actIdea.nombre;
                const max2 = Math.max(...activos.map(d=>parseInt(d.valores[actIdea.id])||0)) || 1;
                activos.slice(0,10).forEach(d => {
                    const val = parseInt(d.valores[actIdea.id])||0;
                    c2.innerHTML += `<div class="bar-container"><div class="bar-name">${d.name}</div><div class="bar-bg"><div class="bar-fill" style="width:${(val/max2)*100}%; background:var(--accent)">${val}</div></div></div>`;
                });
            }
        }

        // --- GESTI√ìN FORMULARIO ---
        function abrirModal() {
            if(esModoLectura) return;
            indiceEdicion = -1;
            document.getElementById('form-gestor').reset();
            document.getElementById('input-id').disabled = false;
            verificarOtroDepto();
            renderFormFields({});
            document.getElementById('modal').style.display = 'flex';
        }

        function cargarEdicion(index) {
            if(esModoLectura) return;
            if (!datos[index].activo) { alert("Gestor inactivo. Reactivar primero."); return; }
            indiceEdicion = index;
            const d = datos[index];
            document.getElementById('input-id').value = d.id;
            document.getElementById('input-id').disabled = true;
            document.getElementById('input-nombre').value = d.name;
            
            const sel = document.getElementById('input-depto');
            let match = false;
            for(let op of sel.options) if(op.value === d.depto) match = true;
            if(match) sel.value = d.depto;
            else { sel.value = 'OTRO'; document.getElementById('input-otro-depto').value = d.depto; }
            verificarOtroDepto();
            
            renderFormFields(d.valores);
            calcularTotalEnVivo();
            document.getElementById('modal').style.display = 'flex';
        }

        function renderFormFields(vals) {
            const div = document.getElementById('dynamic-form-fields'); div.innerHTML = "";
            configNormativa.forEach(c => {
                let html = `<div style="margin-bottom:10px;">`;
                if(c.tipo === 'check') {
                    html += `<label style="display:flex;align-items:center;gap:10px;border:1px solid #eee;padding:10px;border-radius:8px;"><input type="checkbox" id="field_${c.id}" onchange="calcularTotalEnVivo()" ${vals[c.id]?'checked':''}> ${c.nombre} (+${c.valor})</label>`;
                } else {
                    html += `<label class="form-label">${c.nombre} (${c.valor} pts/u)</label><input type="number" id="field_${c.id}" class="form-input" value="${vals[c.id]||0}" oninput="calcularTotalEnVivo()">`;
                }
                div.innerHTML += html + `</div>`;
            });
        }

        function verificarOtroDepto() {
            const isOtro = document.getElementById('input-depto').value === 'OTRO';
            document.getElementById('input-otro-depto').style.display = isOtro ? 'block' : 'none';
            document.getElementById('input-otro-depto').required = isOtro;
        }

        function calcularTotalEnVivo() {
            let temp = {};
            configNormativa.forEach(c => {
                const el = document.getElementById(`field_${c.id}`);
                temp[c.id] = c.tipo==='check' ? el.checked : (parseInt(el.value)||0);
            });
            document.getElementById('preview-total').textContent = calcularPuntos(temp).toLocaleString();
        }

        function cerrarModal() { document.getElementById('modal').style.display = 'none'; }

        // --- GESTI√ìN CONFIGURACI√ìN ---
        function abrirConfig() { renderConfigItems(); document.getElementById('modal-config').style.display = 'flex'; }
        function cerrarConfig() { document.getElementById('modal-config').style.display = 'none'; }
        
        function renderConfigItems() {
            const div = document.getElementById('config-items-container'); div.innerHTML = "";
            configNormativa.forEach((c, idx) => {
                div.innerHTML += `<div class="config-row">
                    <div style="flex:2"><label style="font-size:10px">Nombre</label><input class="form-input" value="${c.nombre}" onchange="configNormativa[${idx}].nombre=this.value"></div>
                    <div style="flex:1"><label style="font-size:10px">Tipo</label><select class="form-input" onchange="configNormativa[${idx}].tipo=this.value"><option value="check" ${c.tipo=='check'?'selected':''}>Check</option><option value="number" ${c.tipo=='number'?'selected':''}>Num</option></select></div>
                    <div style="flex:1"><label style="font-size:10px">Valor</label><input type="number" class="form-input" value="${c.valor}" onchange="configNormativa[${idx}].valor=parseInt(this.value)"></div>
                    <button type="button" onclick="eliminarActividadConfig(${idx})" style="color:red;border:none;background:none;font-weight:bold;">X</button>
                </div>`;
            });
        }
        function agregarActividadConfig() { configNormativa.push({id:'act_'+Date.now(), nombre:'Nueva', tipo:'number', valor:100}); renderConfigItems(); }
        function eliminarActividadConfig(i) { configNormativa.splice(i,1); renderConfigItems(); }

    </script>
</body>
</html>
